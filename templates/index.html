<!DOCTYPE html>
<html>
<head>
    <title>Unified Flight Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body, html { height: 100%; margin: 0; padding: 0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; overflow: hidden; }
        
        /* Flex Layout */
        #container { display: flex; height: 100vh; width: 100vw; }
        
        /* Left Dashboard (40%) */
        #dashboard {
            width: 40%;
            height: 100%;
            background: #f8f9fa;
            border-right: 1px solid #ddd;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            z-index: 10;
        }

        /* Right Map Container (60%) */
        #right-panel { width: 60%; height: 100%; position: relative; }
        #map { height: 100%; width: 100%; display: block; }
        #sky-view { height: 100%; width: 100%; display: none; background: #111; position: relative; }

        /* View Toggle Tabs */
        .view-tabs {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 50;
            background: white;
            border-radius: 4px;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
            display: flex;
            overflow: hidden;
        }
        .view-tab {
            padding: 8px 16px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        .view-tab.active {
            background: #4285F4;
            color: white;
        }
        .view-tab:hover:not(.active) {
            background: #f1f1f1;
        }

        /* Dashboard Components */
        .header { padding: 15px; background: #fff; border-bottom: 1px solid #eee; }
        .controls { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .controls label { font-size: 12px; font-weight: bold; color: #555; }
        .controls input { width: 100%; padding: 5px; border: 1px solid #ccc; border-radius: 4px; }
        
        button.scan-btn {
            width: 100%; background: #4285F4; color: white; border: none; padding: 8px; 
            border-radius: 4px; cursor: pointer; font-weight: bold; margin-top: 5px;
        }
        button.scan-btn:hover { background: #3367d6; }

        #status { font-size: 12px; color: #666; margin-top: 5px; min-height: 1.2em; }
        .error-text { color: #d93025; font-weight: bold; }

        /* Scrollable Table */
        .table-container {
            flex: 1;
            overflow-y: auto;
            background: white;
            border-top: 1px solid #eee;
        }

        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        
        thead th {
            position: sticky; top: 0; background: #e8eaed; 
            color: #333; padding: 8px; text-align: left; 
            border-bottom: 2px solid #ccc; font-weight: 600;
            cursor: pointer; user-select: none;
        }
        thead th:hover { background-color: #d2e3fc; }
        
        tbody tr { border-bottom: 1px solid #f1f1f1; cursor: pointer; }
        tbody tr:hover { background-color: #e8f0fe; }
        tbody td { padding: 8px; white-space: nowrap; }
        
        /* Column Specifics */
        .col-right { text-align: right; }
        .source-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .sort-icon { font-size: 10px; margin-left: 5px; color: #555; }

        /* Scrollbar styling */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }

        /* Sky View Tooltip */
        #sky-tooltip {
            position: absolute;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            pointer-events: none;
            display: none;
            font-size: 12px;
            z-index: 100;
        }

    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}"></script>
</head>
<body>

<div id="container">
    <div id="dashboard">
        <div class="header">
            <h2 style="margin: 0 0 10px 0; color: #202124;">Flight Tracker</h2>
            <div class="controls">
                <div><label>Lat</label><input type="number" id="obsLat" step="0.0001" value="{{ default_lat }}"></div>
                <div><label>Lon</label><input type="number" id="obsLon" step="0.0001" value="{{ default_lon }}"></div>
                <div><label>Radius (NM)</label><input type="number" id="obsRadius" value="{{ default_radius }}"></div>
            </div>
            <button class="scan-btn" onclick="updateSettings()">Update & Scan</button>
            <div id="status">Ready.</div>
        </div>
        
        <div class="table-container">
            <table id="flightTable">
                <thead>
                    <tr>
                        <th onclick="toggleSort('hex_id')">ICAO <span id="sort-hex_id" class="sort-icon"></span></th>
                        <th onclick="toggleSort('callsign')">Ident <span id="sort-callsign" class="sort-icon"></span></th>
                        <th class="col-right" onclick="toggleSort('altitude')">Alt (ft) <span id="sort-altitude" class="sort-icon"></span></th>
                        <th class="col-right" onclick="toggleSort('azimuth')">Az <span id="sort-azimuth" class="sort-icon"></span></th>
                        <th class="col-right" onclick="toggleSort('elevation')">El <span id="sort-elevation" class="sort-icon"></span></th>
                        <th class="col-right" onclick="toggleSort('distance_from_obs')">Dist (NM) <span id="sort-distance_from_obs" class="sort-icon"></span></th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Rows injected here -->
                </tbody>
            </table>
        </div>
    </div>

    <div id="right-panel">
        <div class="view-tabs">
            <button class="view-tab active" id="btn-map" onclick="switchView('map')">Map</button>
            <button class="view-tab" id="btn-sky" onclick="switchView('sky')">Sky View</button>
        </div>

        <div id="map"></div>

        <div id="sky-view">
             <canvas id="skyCanvas"></canvas>
             <div id="sky-tooltip"></div>
        </div>
    </div>
</div>

<script>
    let map;
    let markers = {};
    let rangeCircle;
    let observerMarker; // House icon marker
    let refreshInterval;
    
    // Sort State: { col: string, dir: number } (0: none, 1: asc, 2: desc)
    let sortState = { col: null, dir: 0 };
    let flightCache = [];
    
    // View State
    let currentView = 'map'; // 'map' or 'sky'
    let skyCanvas, skyCtx;

    const planeIcon = {
        path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
        scale: 4,
        fillColor: "#4285F4",
        fillOpacity: 1,
        strokeWeight: 1,
        rotation: 0
    };

    const houseIcon = {
        // SVG path for a simple house
        path: "M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z",
        fillColor: "#0F9D58", // Green
        fillOpacity: 1,
        strokeWeight: 2,
        strokeColor: "#FFFFFF",
        scale: 1.5,
        anchor: new google.maps.Point(12, 12) // Center the icon roughly
    };

    function initMap() {
        // Map Init
        const startPos = { lat: {{ default_lat }}, lng: {{ default_lon }} }; 
        map = new google.maps.Map(document.getElementById("map"), {
            zoom: 9,
            center: startPos,
            mapTypeId: 'terrain',
            streetViewControl: false,
            fullscreenControl: false,
            mapTypeControlOptions: { position: google.maps.ControlPosition.TOP_RIGHT }
        });
        
        drawObserver(startPos.lat, startPos.lng, {{ default_radius }});

        // Sky View Init
        skyCanvas = document.getElementById('skyCanvas');
        skyCtx = skyCanvas.getContext('2d');
        resizeSkyCanvas();
        window.addEventListener('resize', resizeSkyCanvas);

        // Sky View Interaction
        skyCanvas.addEventListener('mousemove', handleSkyHover);

        startTracking();
    }

    function switchView(view) {
        currentView = view;
        document.getElementById('btn-map').className = view === 'map' ? 'view-tab active' : 'view-tab';
        document.getElementById('btn-sky').className = view === 'sky' ? 'view-tab active' : 'view-tab';

        document.getElementById('map').style.display = view === 'map' ? 'block' : 'none';
        document.getElementById('sky-view').style.display = view === 'sky' ? 'block' : 'none';

        if (view === 'sky') {
            resizeSkyCanvas();
            drawSkyView(flightCache);
        }
    }

    function updateSettings() {
        const lat = parseFloat(document.getElementById('obsLat').value);
        const lon = parseFloat(document.getElementById('obsLon').value);
        const rad = parseFloat(document.getElementById('obsRadius').value);
        
        map.setCenter({lat: lat, lng: lon});
        drawObserver(lat, lon, rad);
        
        if (refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(fetchFlights, 10000);
        fetchFlights();
    }

    function drawObserver(lat, lon, radiusNm) {
        const pos = {lat: lat, lng: lon};

        // Draw/Update Range Circle
        if (rangeCircle) rangeCircle.setMap(null);
        const radiusMeters = radiusNm * 1852;
        rangeCircle = new google.maps.Circle({
            strokeColor: "#FF0000", strokeOpacity: 0.8, strokeWeight: 2,
            fillColor: "#FF0000", fillOpacity: 0.05,
            map: map, center: pos, radius: radiusMeters
        });
        map.fitBounds(rangeCircle.getBounds());

        // Draw/Update House Icon
        if (observerMarker) observerMarker.setMap(null);
        observerMarker = new google.maps.Marker({
            position: pos,
            map: map,
            icon: houseIcon,
            title: "Observer Location",
            zIndex: 1000 // Ensure it stays on top of planes
        });
    }

    function startTracking() {
        refreshInterval = setInterval(fetchFlights, 10000);
        fetchFlights();
    }

    async function fetchFlights() {
        const lat = document.getElementById('obsLat').value;
        const lon = document.getElementById('obsLon').value;
        const rad = document.getElementById('obsRadius').value;
        const statusDiv = document.getElementById('status');
        
        // Only show text if table is empty to avoid flicker
        if (flightCache.length === 0) statusDiv.innerHTML = "Fetching data...";

        try {
            const response = await fetch(`/api/flights?lat=${lat}&lon=${lon}&radius=${rad}`);
            const data = await response.json();
            
            if (data.messages && data.messages.length > 0) {
                 const errorHtml = data.messages.join(", ");
                 statusDiv.innerHTML = `<span class="error-text">Warnings: ${errorHtml}</span>`;
            } else {
                 statusDiv.innerHTML = `Tracking ${data.flights.length} aircraft. Updated: ${new Date().toLocaleTimeString()}`;
            }
            
            flightCache = data.flights; // Store for sorting/rendering

            updateMarkers(data.flights);
            if (currentView === 'sky') drawSkyView(data.flights);

            renderTable(); // Render based on cache and sort state
            
        } catch (error) {
            console.error("Error fetching flights:", error);
            statusDiv.innerHTML = "<span class='error-text'>Connection Error. Check console.</span>";
        }
    }

    function updateMarkers(flights) {
        if (!flights) return;
        const currentHexIds = new Set(flights.map(f => f.hex_id));
        
        for (let hex in markers) {
            if (!currentHexIds.has(hex)) {
                markers[hex].setMap(null);
                delete markers[hex];
            }
        }
        flights.forEach(f => {
            const pos = { lat: f.lat, lng: f.lon };
            const icon = { ...planeIcon, rotation: f.heading };
            
            let color = "#4285F4"; // FA Blue
            if (f.source.includes("Merged")) color = "#800080"; // Merged Purple
            else if (f.source.includes("Local")) color = "#0F9D58"; // Local Green
            else if (f.source === "Flightradar24") color = "#FFD700"; // FR24 Gold
            
            icon.fillColor = color;

            const contentString = `<div style="color:black"><b>${f.callsign}</b><br>Hex: ${f.hex_id}<br>Alt: ${f.altitude}ft<br>Az: ${f.azimuth}° El: ${f.elevation}°</div>`;

            if (markers[f.hex_id]) {
                markers[f.hex_id].setPosition(pos);
                markers[f.hex_id].setIcon(icon);
                markers[f.hex_id]._infoContent = contentString;
            } else {
                const marker = new google.maps.Marker({ position: pos, map: map, icon: icon, title: f.callsign });
                marker._infoWindow = new google.maps.InfoWindow({ content: contentString });
                marker._infoContent = contentString;
                marker.addListener("click", () => {
                     marker._infoWindow.setContent(marker._infoContent);
                     marker._infoWindow.open(map, marker);
                });
                markers[f.hex_id] = marker;
            }
        });
    }

    // --- SKY VIEW LOGIC ---
    function resizeSkyCanvas() {
        const parent = document.getElementById('sky-view');
        skyCanvas.width = parent.clientWidth;
        skyCanvas.height = parent.clientHeight;
        if (currentView === 'sky') drawSkyView(flightCache);
    }

    function drawSkyView(flights) {
        const w = skyCanvas.width;
        const h = skyCanvas.height;
        const cx = w / 2;
        const cy = h / 2;
        const r = Math.min(cx, cy) - 40; // Max radius with padding

        // Clear
        skyCtx.clearRect(0, 0, w, h);

        // Draw Background Rings
        skyCtx.strokeStyle = "rgba(255, 255, 255, 0.3)";
        skyCtx.lineWidth = 1;
        skyCtx.setLineDash([5, 5]); // Dotted

        // Elevations: 0, 30, 60. Center is 90.
        // Radius mapping: r_pixel = R_max * (1 - el/90)

        // Ring for 0 deg (Horizon) - Solid
        skyCtx.beginPath();
        skyCtx.arc(cx, cy, r, 0, 2 * Math.PI);
        skyCtx.stroke();

        // Ring for 30 deg
        const r30 = r * (1 - 30/90);
        skyCtx.beginPath();
        skyCtx.arc(cx, cy, r30, 0, 2 * Math.PI);
        skyCtx.stroke();

        // Ring for 60 deg
        const r60 = r * (1 - 60/90);
        skyCtx.beginPath();
        skyCtx.arc(cx, cy, r60, 0, 2 * Math.PI);
        skyCtx.stroke();

        skyCtx.setLineDash([]); // Reset

        // Draw Crosshairs (N-S, E-W)
        skyCtx.beginPath();
        skyCtx.moveTo(cx, cy - r);
        skyCtx.lineTo(cx, cy + r);
        skyCtx.moveTo(cx - r, cy);
        skyCtx.lineTo(cx + r, cy);
        skyCtx.stroke();

        // Draw Labels (N, E, S, W)
        skyCtx.fillStyle = "white";
        skyCtx.font = "bold 14px Arial";
        skyCtx.textAlign = "center";
        skyCtx.textBaseline = "middle";

        skyCtx.fillText("N", cx, cy - r - 15);
        skyCtx.fillText("S", cx, cy + r + 15);
        skyCtx.fillText("E", cx + r + 15, cy);
        skyCtx.fillText("W", cx - r - 15, cy);

        skyCtx.fillStyle = "rgba(255, 255, 255, 0.5)";
        skyCtx.font = "10px Arial";
        skyCtx.fillText("30°", cx + r30 + 10, cy + 10);
        skyCtx.fillText("60°", cx + r60 + 10, cy + 10);

        // Plot Aircraft
        flights.forEach(f => {
            if (f.elevation < 0) return; // Below horizon

            const azRad = (f.azimuth - 90) * (Math.PI / 180); // Canvas 0 is Right (East), Az 0 is Up (North).
            // Azimuth is clockwise from North. Canvas angle is clockwise from East (usually).
            // Actually Math functions use counter-clockwise from East?
            // Let's manually map:
            // N (Az 0) -> (0, -r)
            // E (Az 90) -> (r, 0)
            // S (Az 180) -> (0, r)
            // W (Az 270) -> (-r, 0)

            // x = r_pixel * sin(Az)
            // y = -r_pixel * cos(Az)  (Negative because Y is down)

            const r_pixel = r * (1 - f.elevation / 90);

            const x = cx + r_pixel * Math.sin(f.azimuth * Math.PI / 180);
            const y = cy - r_pixel * Math.cos(f.azimuth * Math.PI / 180);

            // Store coordinates for tooltip
            f._skyX = x;
            f._skyY = y;

            // Draw Dot
            skyCtx.beginPath();
            skyCtx.arc(x, y, 4, 0, 2 * Math.PI);

            let color = "#4285F4";
            if (f.source.includes("Merged")) color = "#800080";
            else if (f.source.includes("Local")) color = "#0F9D58";
            else if (f.source === "Flightradar24") color = "#FFD700";

            skyCtx.fillStyle = color;
            skyCtx.fill();
            skyCtx.strokeStyle = "white";
            skyCtx.stroke();

            // Optional: Heading Indicator
            // Small line pointing in heading direction
            // Heading is clockwise from North
            const hdgRad = (f.heading - 90) * (Math.PI / 180);
            // Standard math angle is ccw from East.
            // Hdg 0 (N) -> -90 deg standard? No.
            // Hdg 0 should point Up.
            // x_h = x + len * sin(Hdg)
            // y_h = y - len * cos(Hdg)

            skyCtx.beginPath();
            skyCtx.moveTo(x, y);
            skyCtx.lineTo(x + 10 * Math.sin(f.heading * Math.PI/180), y - 10 * Math.cos(f.heading * Math.PI/180));
            skyCtx.strokeStyle = color;
            skyCtx.stroke();
        });
    }

    function handleSkyHover(e) {
        if (currentView !== 'sky') return;

        const rect = skyCanvas.getBoundingClientRect();
        const mouseX = e.clientX - rect.left;
        const mouseY = e.clientY - rect.top;

        const tooltip = document.getElementById('sky-tooltip');
        let found = null;

        // Simple hit detection
        for (let f of flightCache) {
            if (f._skyX && f.elevation >= 0) {
                const dx = mouseX - f._skyX;
                const dy = mouseY - f._skyY;
                if (dx*dx + dy*dy < 100) { // 10px radius
                    found = f;
                    break;
                }
            }
        }

        if (found) {
            tooltip.style.display = 'block';
            tooltip.style.left = (mouseX + 10) + 'px';
            tooltip.style.top = (mouseY + 10) + 'px';
            tooltip.innerHTML = `<b>${found.callsign}</b><br>Alt: ${found.altitude}ft<br>Az: ${found.azimuth}° El: ${found.elevation}°`;
        } else {
            tooltip.style.display = 'none';
        }
    }

    // --- SORTING LOGIC ---
    function toggleSort(col) {
        if (sortState.col === col) {
            // Cycle: 0 -> 1 -> 2 -> 0
            sortState.dir = (sortState.dir + 1) % 3;
        } else {
            sortState.col = col;
            sortState.dir = 1; // Default to Asc
        }
        renderTable();
    }

    function renderTable() {
        const tbody = document.querySelector("#flightTable tbody");
        tbody.innerHTML = ""; // Clear existing

        // Create shallow copy for display
        let displayList = [...flightCache];

        // Apply Sort if active (dir 1 or 2)
        if (sortState.dir !== 0 && sortState.col) {
            displayList.sort((a, b) => {
                let v1 = a[sortState.col];
                let v2 = b[sortState.col];
                
                // normalize strings
                if (typeof v1 === 'string') v1 = v1.toLowerCase();
                if (typeof v2 === 'string') v2 = v2.toLowerCase();
                
                // Handle nulls
                if (v1 == null) v1 = -Infinity; // Push nulls to bottom/top
                if (v2 == null) v2 = -Infinity;

                if (v1 < v2) return sortState.dir === 1 ? -1 : 1;
                if (v1 > v2) return sortState.dir === 1 ? 1 : -1;
                return 0;
            });
        }
        // If sortState.dir === 0, we use flightCache 'as is' (Original State from server)

        // Render Rows
        displayList.forEach(f => {
            const tr = document.createElement("tr");
            
            let color = "#4285F4";
            if (f.source.includes("Merged")) color = "#800080";
            else if (f.source.includes("Local")) color = "#0F9D58";
            else if (f.source === "Flightradar24") color = "#FFD700";
            
            // Simplified Source Display: Check inclusions rather than strict equality
            let sourceLabel = "FA";
            if (f.source.includes("Merged")) sourceLabel = "Merged";
            else if (f.source.includes("Local")) sourceLabel = "Local";
            else if (f.source === "Flightradar24") sourceLabel = "FR24";

            // Allow full string for tooltip or more detail if needed, but for now:
            const sourceHtml = `<span class="source-dot" style="background:${color}"></span>${sourceLabel}`;

            // Show distance to 1 decimal place, or '-' if invalid
            const distDisplay = (f.distance_from_obs !== undefined && f.distance_from_obs !== Infinity) 
                                ? f.distance_from_obs.toFixed(1) 
                                : "-";

            tr.innerHTML = `
                <td style="font-family:monospace; font-weight:bold;">${f.hex_id.toUpperCase()}</td>
                <td>${f.callsign}</td>
                <td class="col-right">${f.altitude.toLocaleString()}</td>
                <td class="col-right">${f.azimuth !== undefined ? f.azimuth.toFixed(0) : 0}°</td>
                <td class="col-right">${f.elevation !== undefined ? f.elevation.toFixed(1) : 0}°</td>
                <td class="col-right">${distDisplay}</td>
            `;
            
            // Highlight marker on hover/click
            tr.onclick = () => {
                // If on Sky View, could highlight there too, but mostly for Map
                if (currentView === 'map' && markers[f.hex_id]) {
                    const m = markers[f.hex_id];
                    map.panTo(m.getPosition());
                    m._infoWindow.setContent(m._infoContent);
                    m._infoWindow.open(map, m);
                }
            };
            
            tbody.appendChild(tr);
        });

        // Update Sort Icons
        document.querySelectorAll(".sort-icon").forEach(el => el.innerHTML = "");
        if (sortState.dir !== 0 && sortState.col) {
            const arrow = sortState.dir === 1 ? "▲" : "▼";
            const iconEl = document.getElementById("sort-" + sortState.col);
            if (iconEl) iconEl.innerHTML = arrow;
        }
    }

    window.onload = initMap;
</script>
</body>
</html>
